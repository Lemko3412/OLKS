<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Емоційна мапа</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600&display=swap">
    <style>
        /* Global reset */
        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0;
            padding: 0;
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f5f5f7; /* Light grey Apple-style background */
            color: #1d1d1f;
            display: flex; /* Використовуємо flexbox для основного лейауту */
            flex-direction: column; /* Елементи будуть розміщені зверху вниз */
            min-height: 100vh; /* Займаємо всю висоту екрану */
            overflow: hidden; /* Запобігаємо прокрутці body, коли панелі з'являються */
        }
        #map {
            flex-grow: 1; /* Мапа займатиме весь доступний простір по вертикалі */
            width: 100%;
            min-height: 50vh; /* Мінімальна висота для мапи, щоб не була надто маленькою на мобільних */
            position: relative; /* Для правильного z-index */
            z-index: 1; /* Мапа під усіма елементами керування */
        }
        /* Базові стилі для панелей - на десктопі вони залишаються абсолютними */
        #form, #legend, #admin-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px); /* Frosted-glass effect */
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: all 0.3s ease; /* Smooth animation */
        }

        /* Десктопні стилі (за замовчуванням, або від 769px) */
        @media (min-width: 769px) {
            #form {
                position: absolute;
                top: 20px;
                left: 20px;
                max-width: 320px;
            }
            #legend {
                position: absolute;
                top: 20px;
                right: 20px;
                max-width: 250px;
            }
            #admin-panel {
                position: absolute;
                bottom: 20px;
                right: 20px;
                max-width: 250px;
            }
            #instructions {
                position: absolute;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(0, 0, 0, 0.7);
                color: white;
                padding: 10px 16px;
                border-radius: 8px;
                font-size: 14px;
                z-index: 1000;
                transition: all 0.3s ease;
            }
            /* На десктопі приховуємо кнопки мобільної навігації */
            .mobile-nav-buttons {
                display: none !important;
            }
        }

        /* Мобільні стилі (до 768px) */
        @media (max-width: 768px) {
            body {
                flex-direction: column; /* Елементи вибудовуються вертикально */
            }
            #map {
                height: 100vh; /* Мапа займає 100% висоти на мобільних, щоб панелі могли виїхати поверх */
                min-height: 300px;
            }

            /* Важливо: задаємо фіксовану висоту для кнопок навігації */
            .mobile-nav-buttons {
                display: flex;
                justify-content: space-around;
                padding: 10px;
                background: #fff;
                box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
                z-index: 1001; /* Над усіма панелями та мапою */
                position: fixed; /* Фіксуємо до низу */
                bottom: 0;
                left: 0;
                width: 100%;
                height: 60px; /* Фіксована висота, наприклад 60px */
            }

            .mobile-nav-buttons button {
                flex: 1;
                margin: 0 5px;
                padding: 10px 0;
                font-size: 14px;
                background: #e0e0e0;
                color: #1d1d1f;
                border-radius: 8px;
            }

            .mobile-nav-buttons button.active {
                background: #007aff;
                color: white;
            }

            /* Панелі розміщуємо внизу, по центру, використовуючи фіксоване позиціонування */
            #form, #legend, #admin-panel {
                position: fixed;
                bottom: var(--mobile-nav-height, 60px); /* Піднімаємо на висоту навігаційної панелі */
                left: 0;
                width: 100%;
                max-width: none;
                border-radius: 12px 12px 0 0;
                padding: 15px;
                box-shadow: 0 -4px 30px rgba(0, 0, 0, 0.1);
                transform: translateY(100%); /* Приховати за екраном */
                transition: transform 0.3s ease-out;
                z-index: 1000; /* Під кнопками навігації */
                max-height: calc(100vh - var(--mobile-nav-height, 60px) - 20px); /* Обмежуємо висоту, щоб не вилазили за екран, -20px для відступу зверху */
                overflow-y: auto; /* Додаємо прокрутку, якщо вміст більший */
            }

            #form.visible, #legend.visible, #admin-panel.visible {
                transform: translateY(0); /* Показати панель */
            }

            /* Це важливо: додаємо правило, щоб форма залишалася видимою, коли поле вводу у фокусі */
            #form.visible.focused-input {
                transform: translateY(0) !important; /* Примусово залишаємо її видимої */
            }

            /* Інструкції */
            #instructions {
                position: fixed;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                font-size: 12px;
                padding: 8px 12px;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                z-index: 1002; /* Над усім, включаючи кнопки навігації */
            }

            /* Приховуємо інші панелі, коли одна активна */
            #form:not(.visible),
            #legend:not(.visible),
            #admin-panel:not(.visible) {
                display: none;
            }
        }

        /* Utility */
        .hidden { display: none !important; }

        /* Adjusted selectors for input types to be more specific */
        select, input[type="text"], input[type="email"], input[type="password"] {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: 1px solid #d2d2d7;
            border-radius: 8px;
            font-size: 14px;
            background: #fff;
            outline: none;
            transition: border-color 0.2s ease;
        }
        select:focus, input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus {
            border-color: #007aff; /* iOS blue accent */
        }
        button {
            width: 100%;
            padding: 10px;
            margin: 8px 0;
            border: none;
            border-radius: 8px;
            background: #007aff;
            color: white;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        button:hover { background: #005bb5; }
        .delete-button { background: #ff2d55; }
        .delete-button:hover { background: #d70015; }
        h3 {
            margin: 0 0 12px;
            font-size: 18px;
            font-weight: 600;
            color: #1d1d1f;
        }
        h4 {
            margin: 0 0 8px;
            font-size: 16px;
            font-weight: 600;
        }
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 13px;
            font-weight: 500;
        }
        .legend-color {
            width: 16px;
            height: 16px;
            margin-right: 8px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="instructions">Клікніть на мапу, щоб обрати локацію для нової точки.</div>

    <div class="mobile-nav-buttons">
        <button id="show-form-btn">Додати точку</button>
        <button id="show-legend-btn">Легенда</button>
        <button id="show-admin-btn">Адмін</button>
    </div>

    <div id="legend">
        <h4>Легенда</h4>
        <div class="legend-item"><div class="legend-color" style="background: #006400;"></div>Я люблю проводити тут час</div>
        <div class="legend-item"><div class="legend-color" style="background: #8B0000;"></div>Я уникаю це місце</div>
        <div class="legend-item"><div class="legend-color" style="background: #008B8B;"></div>Я бачу тут потенціал</div>
        <div class="legend-item"><div class="legend-color" style="background: #B8860B;"></div>Я пишаюсь цим місцем</div>
    </div>

    <div id="form" class="hidden">
        <h3>Додати точку</h3>
        <select id="category">
            <option value="">Оберіть категорію</option>
            <option value="love">Я люблю проводити тут час</option>
            <option value="avoid">Я уникаю це місце</option>
            <option value="potential">Я бачу тут потенціал</option>
            <option value="proud">Я пишаюсь цим місцем</option>
        </select>
        <input type="text" id="name" placeholder="Назва точки">
        <input type="text" id="description" placeholder="Опис (необов’язково)">
        <button onclick="addMarkerFromForm()">Додати точку</button>
        <button onclick="cancelMarker()" style="background:#d2d2d7;color:#1d1d1f;">Скасувати</button>
    </div>

    <div id="admin-panel">
        <h3>Режим відладки</h3>
        <input type="email" id="admin-email" placeholder="Введіть пошту">
        <input type="password" id="admin-password" placeholder="Введіть пароль">
        <button onclick="enterAdminMode()" id="enter-admin">Увійти</button>
        <button onclick="exitAdminMode()" id="exit-admin" class="hidden">Вийти</button>
        <button onclick="exportGeoJSON()" id="export-geojson" class="hidden">Експорт у GeoJSON</button>
        <button onclick="deleteAllMarkers()" id="delete-all" class="hidden delete-button">Видалити всі маркери</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>

    <script>
        // Firebase configuration (ВСТАВТЕ СЮДИ ВАШІ РЕАЛЬНІ ДАНІ З FIREBASE CONSOLE!)
        const firebaseConfig = {
            apiKey: "AIzaSyAO54NkFh3DmWzcMn2LJe93uetyXY3OHJs", // ЗАМІНІТЬ НА ВАШ РЕАЛЬНИЙ API KEY
            authDomain: "olks-79ce8.firebaseapp.com",
            projectId: "olks-79ce8",
            storageBucket: "olks-79ce8.firebasestorage.app",
            messagingSenderId: "968971749709",
            appId: "1:968971749709:web:8254a15b889f65bdbc0f04",
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        const map = L.map('map').setView([48.645, 33.119], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        const form = document.getElementById('form');
        const legend = document.getElementById('legend');
        const adminPanel = document.getElementById('admin-panel');

        const categorySelect = document.getElementById('category');
        const nameInput = document.getElementById('name');
        const descriptionInput = document.getElementById('description');
        const instructions = document.getElementById('instructions');

        const adminEmailInput = document.getElementById('admin-email');
        const adminPasswordInput = document.getElementById('admin-password');
        const enterAdminBtn = document.getElementById('enter-admin');
        const exitAdminBtn = document.getElementById('exit-admin');
        const exportGeoJSONBtn = document.getElementById('export-geojson');
        const deleteAllBtn = document.getElementById('delete-all');

        const showFormBtn = document.getElementById('show-form-btn');
        const showLegendBtn = document.getElementById('show-legend-btn');
        const showAdminBtn = document.getElementById('show-admin-btn');
        const mobileNavButtons = document.querySelector('.mobile-nav-buttons');

        // Визначаємо висоту мобільної навігаційної смуги як CSS змінну
        document.documentElement.style.setProperty('--mobile-nav-height', '60px'); // Відповідає height у CSS

        let tempMarker = null;
        let markers = [];
        let isAddingMarker = true;
        let isAdminMode = false;

        const CATEGORY_COLORS = {
            love: '#006400',
            avoid: '#8B0000',
            potential: '#008B8B',
            proud: '#B8860B'
        };

        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

        function createCustomIcon(color) {
            return L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="background-color: ${color}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px ${color};"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
        }

        async function addMarkerToFirestore(lat, lng, category, name, description) {
            const userId = auth.currentUser ? auth.currentUser.uid : null;
            try {
                const docRef = await db.collection("markers").add({
                    lat: lat,
                    lng: lng,
                    category: category,
                    name: name,
                    description: description,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    userId: userId
                });
                console.log("Документ успішно додано з ID: ", docRef.id);
                return docRef.id;
            } catch (e) {
                console.error("Помилка додавання документа: ", e);
                alert("Помилка додавання точки. Спробуйте ще раз.");
                return null;
            }
        }

        async function loadMarkersFromFirestore() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
            try {
                const querySnapshot = await db.collection("markers").get();
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    addMarkerToMap(data.lat, data.lng, data.category, data.name, data.description, doc.id);
                });
            } catch (e) {
                console.error("Помилка завантаження документів: ", e);
            }
        }

        async function deleteMarkerFromFirestore(id) {
            try {
                await db.collection("markers").doc(id).delete();
                console.log("Документ успішно видалено!");
                return true;
            } catch (e) {
                console.error("Помилка видалення документа: ", e);
                if (e.code === 'permission-denied') {
                    alert('У вас немає дозволу на видалення цієї точки. Переконайтеся, що ви увійшли як адміністратор.');
                } else {
                    alert('Помилка видалення точки. Спробуйте ще раз.');
                }
                return false;
            }
        }

        map.on('click', function(e) {
            if (isAddingMarker) {
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                }
                tempMarker = L.marker(e.latlng, { opacity: 0.7, draggable: true }).addTo(map);
                tempMarker.on('dragend', function(event) {
                    instructions.textContent = `Обрана локація: ${event.target.getLatLng().lat.toFixed(4)}, ${event.target.getLatLng().lng.toFixed(4)}. Оберіть категорію.`;
                });
                instructions.textContent = `Обрана локація: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}. Оберіть категорію.`;

                // Для мобільних: показуємо форму при виборі точки
                if (window.innerWidth <= 768) {
                    showPanel(form, showFormBtn);
                } else {
                    form.classList.remove('hidden');
                }
            }
        });

        function toggleAddMarkerMode(enable) {
            isAddingMarker = enable;
            if (enable) {
                instructions.classList.remove('hidden');
                instructions.textContent = 'Клікніть на мапу, щоб обрати локацію для нової точки.';
            } else {
                instructions.classList.add('hidden');
                if (window.innerWidth > 768) {
                    form.classList.add('hidden');
                }
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
            }
        }

        async function addMarkerFromForm() {
            const category = categorySelect.value;
            const name = nameInput.value.trim();
            const description = descriptionInput.value.trim();

            if (!tempMarker) {
                alert('Будь ласка, спочатку оберіть локацію на мапі!');
                return;
            }
            if (!category) {
                alert('Будь ласка, оберіть категорію!');
                return;
            }
            if (!name) {
                alert('Будь ласка, введіть назву точки!');
                return;
            }

            const latlng = tempMarker.getLatLng();

            const newMarkerId = await addMarkerToFirestore(latlng.lat, latlng.lng, category, name, description);
            if (newMarkerId) {
                addMarkerToMap(latlng.lat, latlng.lng, category, name, description, newMarkerId);
            } else {
                // Помилка вже була оброблена в addMarkerToFirestore
            }

            cancelMarker();
        }

        function cancelMarker() {
            form.classList.remove('visible'); // Видаляємо клас 'visible'
            form.classList.add('hidden'); // Додаємо 'hidden' назад для десктопу

            nameInput.value = '';
            descriptionInput.value = '';
            categorySelect.value = '';
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
            instructions.textContent = 'Клікніть на мапу, щоб обрати локацію для нової точки.';
            if (window.innerWidth <= 768) {
                // При скасуванні, якщо ми на мобільному, просто приховати панель, але залишити кнопки навігації
                hideAllPanels(); // Приховуємо всі панелі
                // Не скидаємо активний стан з кнопок мобільної навігації автоматично тут
            }
        }

        function addMarkerToMap(lat, lng, category, name, description, id) {
            const color = CATEGORY_COLORS && CATEGORY_COLORS.hasOwnProperty(category) ? CATEGORY_COLORS[category] : 'gray';
            const icon = createCustomIcon(color);

            const marker = L.marker([lat, lng], { icon: icon });

            marker.id = id;
            marker.category = category;
            marker.name = name;
            marker.description = description;

            let popupContent = `
                <h4>${escapeHtml(name)}</h4>
                <p><strong>Категорія:</strong> ${escapeHtml(category)}</p>
                ${description ? `<p>${escapeHtml(description)}</p>` : ''}
            `;

            if (isAdminMode) {
                popupContent += `<button class="delete-button" onclick="deleteMarkerById('${id}')">Видалити</button>`;
            }
            marker.bindPopup(popupContent);

            marker.addTo(map);
            markers.push(marker);

            marker.on('popupopen', function() {
                updateAllMarkerPopups();
            });
        }

        function updateAllMarkerPopups() {
            markers.forEach(marker => {
                let popupContent = `
                    <h4>${escapeHtml(marker.name)}</h4>
                    <p><strong>Категорія:</strong> ${escapeHtml(marker.category)}</p>
                    ${marker.description ? `<p>${escapeHtml(marker.description)}</p>` : ''}
                `;
                if (isAdminMode) {
                    popupContent += `<button class="delete-button" onclick="deleteMarkerById('${marker.id}')">Видалити</button>`;
                }
                marker.setPopupContent(popupContent);
            });
        }

        async function deleteMarkerById(id) {
            if (!isAdminMode) {
                alert('Ви не в режимі адміністратора. Увійдіть, щоб видалити точки.');
                return;
            }

            if (confirm('Ви впевнені, що хочете видалити цю точку?')) {
                const success = await deleteMarkerFromFirestore(id);
                if (success) {
                    const markerToDelete = markers.find(m => m.id == id);
                    if (markerToDelete) {
                        map.removeLayer(markerToDelete);
                        markers = markers.filter(m => m.id != id);
                    }
                } else {
                    // Помилка вже була оброблена в deleteMarkerFromFirestore
                }
            }
        }

        async function enterAdminMode() {
            const email = adminEmailInput.value.trim();
            const password = adminPasswordInput.value.trim();

            if (!email || !password) {
                alert('Будь ласка, введіть Email та пароль адміністратора.');
                return;
            }

            try {
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                const user = userCredential.user;

                const adminEmail = "mrqwinq@gmail.com";

                if (user.email === adminEmail) {
                    isAdminMode = true;
                    toggleAddMarkerMode(false);

                    adminEmailInput.classList.add('hidden');
                    adminPasswordInput.classList.add('hidden');
                    enterAdminBtn.classList.add('hidden');

                    exitAdminBtn.classList.remove('hidden');
                    exportGeoJSONBtn.classList.remove('hidden');
                    deleteAllBtn.classList.remove('hidden');

                    instructions.classList.add('hidden');
                    updateAllMarkerPopups();

                    if (window.innerWidth <= 768) {
                        showPanel(adminPanel, showAdminBtn); // Показуємо адмін-панель
                    } else {
                        // На десктопі, якщо адмін увійшов, приховуємо форму
                        form.classList.add('hidden');
                    }

                } else {
                    await auth.signOut();
                    alert('Доступ заборонено. Тільки адміністратори можуть увійти.');
                }
            } catch (error) {
                console.error("Помилка входу: ", error.message);
                let errorMessage = 'Помилка входу. ';
                switch (error.code) {
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage += 'Невірний Email або пароль.';
                        break;
                    case 'auth/invalid-email':
                        errorMessage += 'Невірний формат Email.';
                        break;
                    default:
                        errorMessage += 'Спробуйте ще раз.';
                }
                alert(errorMessage);
            }
            adminEmailInput.value = '';
            adminPasswordInput.value = '';
        }

        async function exitAdminMode() {
            try {
                await auth.signOut();
                isAdminMode = false;

                adminEmailInput.classList.remove('hidden');
                adminPasswordInput.classList.remove('hidden');
                enterAdminBtn.classList.remove('hidden');

                exitAdminBtn.classList.add('hidden');
                exportGeoJSONBtn.classList.add('hidden');
                deleteAllBtn.classList.add('hidden');

                toggleAddMarkerMode(true); // Після виходу з адміна, дозволяємо додавати звичайним користувачам

                updateAllMarkerPopups();
                alert('Ви вийшли з адмін-режиму.');

                if (window.innerWidth <= 768) {
                    hideAllPanels(); // Приховуємо всі панелі
                    // При виході з адмін-режиму на мобільних, логічно показати форму додавання точок або мапу.
                    // Можемо залишити просто мапу з інструкціями.
                } else {
                    // На десктопі, після виходу з адміна, знову показуємо форму
                    form.classList.remove('hidden');
                }

            } catch (error) {
                console.error("Помилка виходу: ", error.message);
                alert('Помилка виходу. Спробуйте ще раз.');
            }
        }

        function exportGeoJSON() {
            if (!isAdminMode) {
                alert('Ви не в режимі адміністратора, щоб експортувати дані.');
                return;
            }

            const geoJsonFeatures = markers.map(marker => {
                return {
                    "type": "Feature",
                    "properties": {
                        "id": marker.id,
                        "category": marker.category,
                        "name": marker.name,
                        "description": marker.description,
                        "color": CATEGORY_COLORS && CATEGORY_COLORS.hasOwnProperty(marker.category) ? CATEGORY_COLORS[marker.category] : 'gray'
                    },
                    "geometry": {
                        "type": "Point",
                        "coordinates": [marker.getLatLng().lng, marker.getLatLng().lat]
                    }
                };
            });

            const geoJson = {
                "type": "FeatureCollection",
                "features": geoJsonFeatures
            };

            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geoJson, null, 2));
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "map_data.geojson");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        async function deleteAllMarkers() {
            if (!isAdminMode) {
                alert('Ви не в режимі адміністратора, щоб видалити всі точки.');
                return;
            }
            if (confirm('Ви впевнені, що хочете видалити ВСІ точки? Цю дію не можна скасувати!')) {
                const allMarkersSnapshot = await db.collection("markers").get();
                const batch = db.batch();

                allMarkersSnapshot.forEach(doc => {
                    batch.delete(doc.ref);
                });

                try {
                    await batch.commit();
                    markers.forEach(marker => map.removeLayer(marker));
                    markers = [];
                    alert('Всі точки видалено!');
                } catch (e) {
                    console.error("Помилка при видаленні всіх точок: ", e);
                    if (e.code === 'permission-denied') {
                        alert('У вас немає дозволу на видалення всіх точок. Переконайтеся, що ви увійшли як адміністратор.');
                    } else {
                        alert('Помилка при видаленні всіх точок. Перевірте консоль розробника.');
                    }
                }
            }
        }

        // --- Функції для управління видимістю панелей на мобільних ---
        function hideAllPanels() {
            form.classList.remove('visible');
            legend.classList.remove('visible');
            adminPanel.classList.remove('visible');
            document.querySelectorAll('.mobile-nav-buttons button').forEach(btn => btn.classList.remove('active'));
            // Після приховання всіх панелей, показуємо інструкції (якщо не в адмін-режимі)
            if (!isAdminMode) {
                instructions.classList.remove('hidden');
            }
        }

        function showPanel(panelElement, buttonElement = null) {
            hideAllPanels(); // Спочатку ховаємо всі панелі та деактивуємо кнопки
            panelElement.classList.remove('hidden'); // Забезпечуємо, що елемент не має display: none
            panelElement.classList.add('visible'); // Викликаємо анімацію
            if (buttonElement) {
                buttonElement.classList.add('active');
            }
            instructions.classList.add('hidden'); // Приховуємо інструкції, коли панель активна
        }

        // Додаємо обробники подій для мобільних кнопок
        showFormBtn.addEventListener('click', () => {
            showPanel(form, showFormBtn);
            toggleAddMarkerMode(true); // Дозволяємо додавати точки
        });
        showLegendBtn.addEventListener('click', () => {
            showPanel(legend, showLegendBtn);
            toggleAddMarkerMode(false); // Вимикаємо додавання точок
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        });
        showAdminBtn.addEventListener('click', () => {
            showPanel(adminPanel, showAdminBtn);
            toggleAddMarkerMode(false); // Вимикаємо додавання точок
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        });

        // --- НОВІ ОБРОБНИКИ ДЛЯ ПОЛІВ ВВЕДЕННЯ ---
        nameInput.addEventListener('focus', () => {
            if (window.innerWidth <= 768) {
                form.classList.add('focused-input'); // Додаємо клас, щоб запобігти приховуванню на мобільних
            }
        });
        nameInput.addEventListener('blur', () => {
            if (window.innerWidth <= 768) {
                form.classList.remove('focused-input'); // Видаляємо клас
            }
        });

        descriptionInput.addEventListener('focus', () => {
            if (window.innerWidth <= 768) {
                form.classList.add('focused-input');
            }
        });
        descriptionInput.addEventListener('blur', () => {
            if (window.innerWidth <= 768) {
                form.classList.remove('focused-input');
            }
        });

        categorySelect.addEventListener('focus', () => {
            if (window.innerWidth <= 768) {
                form.classList.add('focused-input');
            }
        });
        categorySelect.addEventListener('blur', () => {
            if (window.innerWidth <= 768) {
                form.classList.remove('focused-input');
            }
        });
        // --- КІНЕЦЬ НОВИХ ОБРОБНИКІВ ---

        loadMarkersFromFirestore();

        auth.onAuthStateChanged(user => {
            if (user) {
                console.log("Користувач увійшов: ", user.email);
                const adminEmail = "mrqwinq@gmail.com";
                if (user.email === adminEmail) {
                    isAdminMode = true;
                    toggleAddMarkerMode(false);

                    adminEmailInput.classList.add('hidden');
                    adminPasswordInput.classList.add('hidden');
                    enterAdminBtn.classList.add('hidden');

                    exitAdminBtn.classList.remove('hidden');
                    exportGeoJSONBtn.classList.remove('hidden');
                    deleteAllBtn.classList.remove('hidden');

                    instructions.classList.add('hidden');
                    updateAllMarkerPopups();

                    if (window.innerWidth <= 768) {
                        showPanel(adminPanel, showAdminBtn);
                    }
                } else {
                    isAdminMode = false;
                    toggleAddMarkerMode(true);
                }
                updateAllMarkerPopups();
            } else {
                console.log("Користувач вийшов.");
                isAdminMode = false;

                adminEmailInput.classList.remove('hidden');
                adminPasswordInput.classList.remove('hidden');
                enterAdminBtn.classList.remove('hidden');

                exitAdminBtn.classList.add('hidden');
                exportGeoJSONBtn.classList.add('hidden');
                deleteAllBtn.classList.add('hidden');

                toggleAddMarkerMode(true);
                updateAllMarkerPopups();

                if (window.innerWidth <= 768) {
                    hideAllPanels(); // При виході з системи приховуємо всі панелі
                    // І автоматично показуємо інструкції, оскільки користувач не в адмін-режимі
                    instructions.classList.remove('hidden');
                }
            }
        });

        // Ініціалізація видимості панелей при завантаженні
        window.addEventListener('load', () => {
            if (window.innerWidth <= 768) {
                hideAllPanels(); // На мобільних спочатку всі панелі приховані
                // Кнопки навігації завжди видимі на мобільних, немає потреби їх приховувати/показувати тут.
            } else {
                form.classList.remove('hidden');
                legend.classList.remove('hidden');
                adminPanel.classList.remove('hidden');
                mobileNavButtons.classList.add('hidden'); // Приховуємо кнопки мобільної навігації на десктопі
            }
             if (!isAdminMode) {
                toggleAddMarkerMode(true);
            }
        });

        // Перемикаємо відображення панелей при зміні розміру вікна
        window.addEventListener('resize', () => {
            if (window.innerWidth <= 768) {
                hideAllPanels(); // Приховати всі панелі при зміні розміру на мобільний
                mobileNavButtons.classList.remove('hidden');
            } else {
                form.classList.remove('hidden');
                legend.classList.remove('hidden');
                adminPanel.classList.remove('hidden');
                mobileNavButtons.classList.add('hidden');
            }
            if (!isAdminMode) {
                toggleAddMarkerMode(true);
            }
        });
    </script>
</body>
</html>
