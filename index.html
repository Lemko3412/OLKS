<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<script>
    // Firebase configuration (ВСТАВТЕ СЮДИ ВАШІ РЕАЛЬНІ ДАНІ З FIREBASE CONSOLE!)
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "olks-79ce8.firebaseapp.com",
        projectId: "olks-79ce8",
        storageBucket: "olks-79ce8.firebasestorage.app",
        messagingSenderId: "968971749709",
        appId: "1:968971749709:web:8254a15b889f65bdbc0f04",
        // measurementId: "G-KTPEVY0WXM" // measurementId не потрібен для базової роботи Firestore
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); // Get a reference to the Firestore database

    // ЗМІНЕНО: Фіксування поля огляду мапи по координатах зі скріншоту
    const bounds = [[48.494764, 32.861134], [48.732415, 33.391224]];
    const map = L.map('map').fitBounds(bounds); // Встановлення поля огляду за межами

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution:'© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    const form = document.getElementById('form');
    const categorySelect = document.getElementById('category');
    const nameInput = document.getElementById('name');
    const descriptionInput = document.getElementById('description');
    const instructions = document.getElementById('instructions');
    const adminPanel = document.getElementById('admin-panel');
    const adminPasswordInput = document.getElementById('admin-password');
    const enterAdminBtn = document.getElementById('enter-admin');
    const exitAdminBtn = document.getElementById('exit-admin');
    const exportGeoJSONBtn = document.getElementById('export-geojson');
    const deleteAllBtn = document.getElementById('delete-all');

    let tempMarker = null; // Temporary marker for placement
    let markers = []; // Array to store all L.Marker objects
    let isAddingMarker = false;
    let isAdminMode = false;
    const ADMIN_PASSWORD = "your_strong_admin_password"; // <--- ЗМІНІТЬ ЦЕ НА СВІЙ СЕКРЕТНИЙ ПАРОЛЬ!

    // ЗМІНЕНО: Більш контрастні кольори для маркерів
    const CATEGORY_COLORS = {
        love: '#006400',    // Dark Green
        avoid: '#8B0000',   // Dark Red
        potential: '#008B8B', // Dark Cyan
        proud: '#B8860B'    // Dark Goldenrod
    };

    // Function to create a custom colored icon
    function createCustomIcon(color) {
        return L.divIcon({
            className: 'custom-div-icon',
            html: `<div style="background-color: ${color}; width: 16px; height: 16px; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 0 2px ${color};"></div>`,
            iconSize: [20, 20],
            iconAnchor: [10, 10], // Center the icon
            popupAnchor: [0, -10] // Adjust popup position
        });
    }

    // --- Data Handling (Firebase Firestore) ---

    // Функція для додавання маркера в Firestore
    async function addMarkerToFirestore(lat, lng, category, name, description) {
        try {
            const docRef = await db.collection("markers").add({
                lat: lat,
                lng: lng,
                category: category,
                name: name,
                description: description,
                timestamp: firebase.firestore.FieldValue.serverTimestamp() // Додаємо мітку часу
            });
            console.log("Документ успішно додано з ID: ", docRef.id);
            return docRef.id; // Повертаємо ID, який присвоїв Firestore
        } catch (e) {
            console.error("Помилка додавання документа: ", e);
            return null;
        }
    }

    // Функція для завантаження маркерів з Firestore
    async function loadMarkersFromFirestore() {
        // Очищаємо всі існуючі маркери на карті перед завантаженням нових
        markers.forEach(marker => map.removeLayer(marker));
        markers = [];

        try {
            const querySnapshot = await db.collection("markers").get();
            querySnapshot.forEach(doc => {
                const data = doc.data();
                addMarkerToMap(data.lat, data.lng, data.category, data.name, data.description, doc.id);
            });
        } catch (e) {
            console.error("Помилка завантаження документів: ", e);
        }
    }

    // Функція для видалення маркера з Firestore
    async function deleteMarkerFromFirestore(id) {
        try {
            await db.collection("markers").doc(id).delete();
            console.log("Документ успішно видалено!");
            return true;
        } catch (e) {
            console.error("Помилка видалення документа: ", e);
            return false;
        }
    }

    // --- Map Interaction ---
    map.on('click', function(e) {
        if (isAddingMarker) {
            if (tempMarker) {
                map.removeLayer(tempMarker); // Remove previous temp marker if exists
            }
            tempMarker = L.marker(e.latlng, { opacity: 0.7, draggable: true }).addTo(map);
            tempMarker.on('dragend', function(event) {
                // Update location if dragged
                instructions.textContent = `Обрана локація: ${event.target.getLatLng().lat.toFixed(4)}, ${event.target.getLatLng().lng.toFixed(4)}. Оберіть категорію.`;
            });
            instructions.textContent = `Обрана локація: ${e.latlng.lat.toFixed(4)}, ${e.latlng.lng.toFixed(4)}. Оберіть категорію.`;
            form.classList.remove('hidden');
        }
    });

    // Toggle instruction message when adding a marker
    function toggleAddMarkerMode(enable) {
        isAddingMarker = enable;
        if (enable) {
            instructions.classList.remove('hidden');
            instructions.textContent = 'Клікніть на мапу, щоб обрати локацію для нової точки.';
        } else {
            instructions.classList.add('hidden');
            form.classList.add('hidden');
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }
        }
    }

    // Initial call to enable adding
    toggleAddMarkerMode(true); // Always in adding mode by default for participation

    // --- Form Functions ---
    async function addMarkerFromForm() { // Made asynchronous
        const category = categorySelect.value;
        const name = nameInput.value.trim();
        const description = descriptionInput.value.trim();

        if (!tempMarker) {
            alert('Будь ласка, спочатку оберіть локацію на мапі!');
            return;
        }
        if (!category) {
            alert('Будь ласка, оберіть категорію!');
            return;
        }
        if (!name) {
            alert('Будь ласка, введіть назву точки!');
            return;
        }

        const latlng = tempMarker.getLatLng();

        // --- Changed: Save to Firebase ---
        const newMarkerId = await addMarkerToFirestore(latlng.lat, latlng.lng, category, name, description);
        if (newMarkerId) {
            addMarkerToMap(latlng.lat, latlng.lng, category, name, description, newMarkerId); // Add to map after successful save
        } else {
            alert('Помилка при додаванні точки. Спробуйте ще раз.');
        }

        // Clear form and hide
        form.classList.add('hidden');
        nameInput.value = '';
        descriptionInput.value = '';
        categorySelect.value = '';
        if (tempMarker) {
            map.removeLayer(tempMarker);
            tempMarker = null;
        }
        instructions.textContent = 'Клікніть на мапу, щоб обрати локацію для нової точки.';
    }

    function cancelMarker() {
        form.classList.add('hidden');
        nameInput.value = '';
        descriptionInput.value = '';
        categorySelect.value = '';
        if (tempMarker) {
            map.removeLayer(tempMarker);
            tempMarker = null;
        }
        instructions.textContent = 'Клікніть на мапу, щоб обрати локацію для нової точки.';
    }

    function addMarkerToMap(lat, lng, category, name, description, id) {
        const color = CATEGORY_COLORS && CATEGORY_COLORS.hasOwnProperty(category) ? CATEGORY_COLORS[category] : 'gray'; // Safe access to colors
        const icon = createCustomIcon(color);

        const marker = L.marker([lat, lng], { icon: icon });

        // Store custom properties on the marker object
        marker.id = id; // Store the unique ID from Firestore
        marker.category = category;
        marker.name = name;
        marker.description = description;

        let popupContent = `
            <h4>${name}</h4>
            <p><strong>Категорія:</strong> ${category}</p>
            ${description ? `<p>${description}</p>` : ''}
        `;

        // Add delete button only if in admin mode
        if (isAdminMode) {
            popupContent += `<button class="delete-button" onclick="deleteMarkerById('${id}')">Видалити</button>`;
        }
        marker.bindPopup(popupContent);

        marker.addTo(map);
        markers.push(marker);

        marker.on('popupopen', function() {
            updateAllMarkerPopups();
        });
    }

    function updateAllMarkerPopups() {
        markers.forEach(marker => {
            let popupContent = `
                <h4>${marker.name}</h4>
                <p><strong>Категорія:</strong> ${marker.category}</p>
                ${marker.description ? `<p>${marker.description}</p>` : ''}
            `;
            if (isAdminMode) {
                popupContent += `<button class="delete-button" onclick="deleteMarkerById('${marker.id}')">Видалити</button>`;
            }
            marker.setPopupContent(popupContent);
        });
    }

    async function deleteMarkerById(id) { // Made asynchronous
        if (!isAdminMode) return; // Only allow deletion in admin mode

        if (confirm('Ви впевнені, що хочете видалити цю точку?')) {
            // --- Changed: Delete from Firebase ---
            const success = await deleteMarkerFromFirestore(id);
            if (success) {
                const markerToDelete = markers.find(m => m.id == id);
                if (markerToDelete) {
                    map.removeLayer(markerToDelete);
                    markers = markers.filter(m => m.id != id);
                }
            } else {
                alert('Помилка при видаленні точки. Спробуйте ще раз.');
            }
        }
    }

    // --- Admin Functions ---
    function enterAdminMode() {
        if (adminPasswordInput.value === ADMIN_PASSWORD) {
            isAdminMode = true;
            toggleAddMarkerMode(false);

            // ЗМІНЕНО: Правильне керування видимістю елементів адмін-панелі
            adminPasswordInput.classList.add('hidden');
            enterAdminBtn.classList.add('hidden');

            exitAdminBtn.classList.remove('hidden');
            exportGeoJSONBtn.classList.remove('hidden');
            deleteAllBtn.classList.remove('hidden');

            instructions.classList.add('hidden'); // Hide user instructions in admin mode

            // Update popups to show delete button
            updateAllMarkerPopups();
            alert('Успішний вхід в адмін-режим!');
        } else {
            alert('Невірний пароль!');
        }
        adminPasswordInput.value = ''; // Clear password field
    }

    function exitAdminMode() {
        isAdminMode = false;

        // ЗМІНЕНО: Правильне керування видимістю елементів адмін-панелі
        adminPasswordInput.classList.remove('hidden');
        enterAdminBtn.classList.remove('hidden');

        exitAdminBtn.classList.add('hidden');
        exportGeoJSONBtn.classList.add('hidden');
        deleteAllBtn.classList.add('hidden');

        toggleAddMarkerMode(true); // Re-enable user adding markers

        // Update popups to hide delete button
        updateAllMarkerPopups();
        alert('Ви вийшли з адмін-режиму.');
    }

    function exportGeoJSON() {
        const geoJsonFeatures = markers.map(marker => {
            return {
                "type": "Feature",
                "properties": {
                    "id": marker.id,
                    "category": marker.category,
                    "name": marker.name,
                    "description": marker.description,
                    "color": CATEGORY_COLORS && CATEGORY_COLORS.hasOwnProperty(marker.category) ? CATEGORY_COLORS[marker.category] : 'gray' // Safe access to colors
                },
                "geometry": {
                    "type": "Point",
                    "coordinates": [marker.getLatLng().lng, marker.getLatLng().lat]
                }
            };
        });

        const geoJson = {
            "type": "FeatureCollection",
            "features": geoJsonFeatures
        };

        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(geoJson, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "map_data.geojson");
        document.body.appendChild(downloadAnchorNode); // Required for Firefox
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    }

    async function deleteAllMarkers() { // Made asynchronous
        if (!isAdminMode) return;
        if (confirm('Ви впевнені, що хочете видалити ВСІ точки? Цю дію не можна скасувати!')) {
            // --- Changed: Delete all from Firebase ---
            const allMarkersSnapshot = await db.collection("markers").get();
            const batch = db.batch(); // Use batch for efficient deletion of many documents

            allMarkersSnapshot.forEach(doc => {
                batch.delete(doc.ref);
            });

            try {
                await batch.commit(); // Execute the batch operation
                markers.forEach(marker => map.removeLayer(marker));
                markers = [];
                alert('Всі точки видалено!');
            } catch (e) {
                console.error("Помилка при видаленні всіх точок: ", e);
                alert('Помилка при видаленні всіх точок. Перевірте консоль розробника.');
            }
        }
    }

    // Load markers from Firebase when the page loads
    loadMarkersFromFirestore();
</script>
